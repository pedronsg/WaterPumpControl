
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Water Pump Control</title>
  
    <link href="/bootstrap.css" rel="stylesheet">
    <link href="/jumbotron-narrow.css" rel="stylesheet">
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">
	
    <style>
		.btn-file {
			position: relative;
			overflow: hidden;
		}
		.btn-file input[type=file] {
			position: absolute;
			top: 0;
			right: 0;
			min-width: 100%;
			min-height: 100%;
			font-size: 100px;
			text-align: right;
			filter: alpha(opacity=0);
			opacity: 0;
			outline: none;
			background: white;
			cursor: inherit;
			display: block;
		}
    </style>

    <script>
	document.addEventListener('DOMContentLoaded', function() {
	getNetwork();
	}, false);
		function changewifiMode(sel)
	{
		var apForm = document.getElementById("formApMode");
		var clientForm = document.getElementById("formClientMode");

		if(sel==0) //ap
		{
			apForm.style.display = "block";		
			clientForm.style.display = "none";
		}
		else if(sel==1) //client
		{
			apForm.style.display = "none";
			clientForm.style.display = "block";
		}
		else if(sel==2) //ap+client
		{
			apForm.style.display = "block";	
			clientForm.style.display = "block";
		}
		else if(sel==3) //disabled
		{
			formApMode.style.display = "none";
			apForm.style.display = "none";
			clientForm.style.display = "none";
		}
	}

	
	function getNetwork() {
		var xmlhttp = new XMLHttpRequest();

		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == XMLHttpRequest.DONE) {
			   if (xmlhttp.status == 200) {
				   var obj = JSON.parse(xmlhttp.responseText);
				   document.getElementById("wifiMode").value = obj.wifiMode;
				   changewifiMode(obj.wifiMode);		
				   document.getElementById("apModeSSID").value = obj.apModeSSID;	
				   document.getElementById("apModePass").value = obj.apModePass;	
				   document.getElementById("apModePass2").value = obj.apModePass;	
				   document.getElementById("clientModeSSID").value = obj.clientModeSSID;	
				   document.getElementById("clientModePass").value = obj.clientModePass;	
				   document.getElementById("clientDhcpMode").value = obj.clientDhcpMode ? 0 : 1; 	
				   document.getElementById("clientModeIp").value = obj.clientModeIp;	
				   document.getElementById("clientModeMask").value = obj.clientModeMask;	
				   document.getElementById("clientModeGateway").value = obj.clientModeGateway;	
				   document.getElementById("clientModeDns1").value = obj.clientModeDns1;	
			   }
			}
    };

   xmlhttp.open("POST", "/getNetwork", true);
   xmlhttp.send();
}

	function setNetwork()
	{
		var obj = new Object();
		obj.wifiMode  = document.getElementById("wifiMode").value;
		var validity=false;
		
		if(obj.wifiMode==0 || obj.wifiMode==2)//ap
		{
			var apModeSSID = document.getElementById("apModeSSID");
			var apModePass = document.getElementById("apModePass");
			var apModePass2 = document.getElementById("apModePass2");

			obj.apModeSSID  = apModeSSID.value;
			obj.apModePass = apModePass.value;
			if(apModePass.value != apModePass2.value)
			{
				apModePass2.setCustomValidity("Passwords Don't Match");
				apModePass2.reportValidity();
			}
			else if(apModeSSID.reportValidity() && apModePass.reportValidity() && apModePass2.reportValidity())
			{
				validity=true;			
			}
		}
		if (obj.wifiMode==1 || obj.wifiMode==2)//client
		{
			var clientModeSSID= document.getElementById("clientModeSSID");
			var clientModePass= document.getElementById("clientModePass");
			
			obj.clientModeSSID  = clientModeSSID.value;
			obj.clientModePass = clientModePass.value;
			
			obj.clientDhcpMode = (document.getElementById("clientDhcpMode").value==0);
			
			if(clientModeSSID.reportValidity() && clientModePass.reportValidity())
			{
				validity=true;			
			}
			if(!obj.clientDhcpMode)
			{
				var clientModeIp = document.getElementById("clientModeIp");
				var clientModeMask = document.getElementById("clientModeMask");
				var clientModeGateway = document.getElementById("clientModeGateway");
				var clientModeDns1 = document.getElementById("clientModeDns1");
				
				obj.clientModeIp = clientModeIp.value;
				obj.clientModeMask = clientModeMask.value;
				obj.clientModeGateway = clientModeGateway.value;
				obj.clientModeDns1 = clientModeDns1.value;
				
				if(clientModeIp.reportValidity() && clientModeMask.reportValidity() && clientModeGateway.reportValidity() && clientModeDns1.reportValidity())
				{
					validity=true;			
				}else
				{
					validity=false;
				}
			}
		}
		if(obj.wifiMode==3)
		{
			validity=true;
		}
		
		if(validity)
		{
			var jsonString= JSON.stringify(obj);
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function()
			{
				if(xmlHttp.readyState == 4 && xmlHttp.status == 200)
				{
					alert(xmlHttp.responseText);
				}
			}
			xmlHttp.open("POST", "/setNetwork",true); 
			xmlHttp.send(jsonString); 			
		}
	}
	

	function changeClientDhcpMode(sel)
	{
		var formModeIp = document.getElementById("formModeIp");

		if(sel.value==1)
		{
			formModeIp.style.display = "block";
		}
		else
		{
			formModeIp.style.display = "none";
		}
	}
	
	</script>
  </head>

  <body>

    <div class="container">
            <div class="header">
				<nav>
					<ul class="nav nav-pills pull-right">
                    <li role="presentation"><a href="live">Live</a></li>
                    <li role="presentation"  class="active"><a href="network">Network</a></li>
                    <li role="presentation"><a href="settings">Settings</a></li>
					<li role="presentation"><a href="admin">Admin</a></li>
					<li role="presentation" ><a href="logout">Logout</a></li>
					</ul>
				</nav>
				<h3 class="text-muted">PumpControl</h3>
			</div>
		<div class="well">
			<form role="form" method="post" action="">
			
				<div class="form-group">
					<label  for="wifiMode">Wifi Mode</label>  
					<select class="form-control" id="wifiMode" onchange="changewifiMode(this.value)">
						<option value="0" selected>Access Point</option>
						<option value="1">Client mode</option>
						<option value="2">Access Point + Client mode</option>
						<option value="3">Disabled</option>
					</select>			
				</div>
					
				<div class="form-group" id="formApMode" style="display:block;">	
					<legend>Wifi Ap</legend>
					<label  for="apModeSSID">SSID</label> 	
					<div class="form-group">
						<input type="text" class="form-control" id="apModeSSID" placeholder="SSID" data-toggle="tooltip" required title="SSID = Name of your Wifi Network" pattern=".{1,63}" oninvalid="this.setCustomValidity('Insert SSID')" oninput="this.setCustomValidity('')">
					</div>
					<label  for="apModePass">Wifi Password</label>
					<div class="form-group">
						<input type="password" class="form-control" id="apModePass" placeholder="Password" data-toggle="tooltip" required title="Password with min 8 chars length" pattern=".{8,63}" oninvalid="this.setCustomValidity('Invalid Password')" oninput="this.setCustomValidity('')">
					</div>
					<label  for="apModePass2">Repeat Wifi Password</label>
					<div class="form-group">
						<input type="password" class="form-control" id="apModePass2" placeholder="Repeat Password" data-toggle="tooltip" required title="Repeat the  previous Password" pattern=".{8,63}" oninput="this.setCustomValidity('')">
					</div>
				</div>

				<div class="form-group" id="formClientMode" style="display:none;">
					<legend>Wifi Client</legend>
					<label  for="clientModeSSID">SSID</label> 
					<div class="form-group">
						<input type="text" class="form-control" id="clientModeSSID" placeholder="SSID" data-toggle="tooltip" title="SSID = Name of Wifi Network to connect" required pattern=".{1,63}" oninvalid="this.setCustomValidity('Insert SSID')" oninput="this.setCustomValidity('')">
					</div>
					<label  for="clientModePass">Password</label> 
					<div class="form-group">
						<input type="password" class="form-control" id="clientModePass" placeholder="Password" data-toggle="tooltip" title="Wifi Password" required pattern=".{8,63}" oninvalid="this.setCustomValidity('Invalid Password')" oninput="this.setCustomValidity('')">
					</div>
					
					<div class="form-group">
						<label  for="clientDhcpMode">Ip Configuration</label>
						<select class="form-control" id="clientDhcpMode" onchange="changeClientDhcpMode(this)">
							<option value="0" selected>Dhcp Client</option>
							<option value="1">Static Ip</option>
						</select>		
					</div>
					
					<div class="form-group" id="formModeIp" style="display:none;">	
						<label  for="clientModeIp">Ip Address</label> 	
						<div class="form-group">
							<input type="text" class="form-control" id="clientModeIp" placeholder="192.168.1.1" data-toggle="tooltip" title="Device Ip Address" required pattern="((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$" oninvalid="this.setCustomValidity('Invalid Ip Address')" oninput="this.setCustomValidity('')">
						</div>
						<label  for="clientModeMask">NetMask</label> 	
						<div class="form-group">
							<input type="text" class="form-control" id="clientModeMask" placeholder="255.255.255.0" data-toggle="tooltip" title="Netmask" required pattern="((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$" oninvalid="this.setCustomValidity('Invalid NetMask')" oninput="this.setCustomValidity('')">
						</div>
						<label  for="clientModeGateway">Gateway</label> 	
						<div class="form-group">
							<input type="text" class="form-control" id="clientModeGateway" placeholder="192.168.1.1" data-toggle="tooltip" title="Gateway Address" required pattern="((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$" oninvalid="this.setCustomValidity('Invalid Gateway')" oninput="this.setCustomValidity('')">
						</div>
						<label  for="clientModeDns1">Dns</label> 	
						<div class="form-group">
							<input type="text" class="form-control" id="clientModeDns1" placeholder="0.0.0.0" data-toggle="tooltip" title="Primary Dns Server" required pattern="((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$" oninvalid="this.setCustomValidity('Invalid Dns')" oninput="this.setCustomValidity('')">
						</div>
					</div>
				</div>
			
				<div class="form-group">
					<p class="text-right">
						<input id="btSettings" name="singlebutton" class="btn btn-primary" type="button" onclick="setNetwork()" value="Apply" />
					</p>
				</div>
			</form>

		</div>
      <footer class="footer">
        <p>&copy; PumpControl @2019 by <a href="mailto:pedronsg@gmail.com">pedronsg@gmail.com</a></p>
      </footer>

    </div>
  </body>
</html>