
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>PumpControl</title>
    <link href="/bootstrap.css" rel="stylesheet">
    <link href="/jumbotron-narrow.css" rel="stylesheet">
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">
    <script>

	document.addEventListener('DOMContentLoaded', function() {
		getAdmin();
	}, false);
	
	function getAdmin() {
		var xmlhttp = new XMLHttpRequest();

		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == XMLHttpRequest.DONE) {   // XMLHttpRequest.DONE == 4
			   if (xmlhttp.status == 200) {
				   var settingsObj = JSON.parse(xmlhttp.responseText);
				   document.getElementById("httpUser").value = settingsObj.httpUser;	
				   document.getElementById("httpPass").value = settingsObj.httpPass;
				   document.getElementById("httpPass2").value = settingsObj.httpPass;
				   firmversion.innerText = "Current firmware: " + settingsObj.firmversion;
			   }
			}
		};
		xmlhttp.open("POST", "/getAdmin", true);
		xmlhttp.send();
	}

	
	function confirmReboot(){	
		var r = confirm("Reboot System!\n Are you sure?");
		if (r) {
			setCommand("reboot");
		} 
	}
	function confirmReset(){	
		var r = confirm("Reset, you will lose all your configuration!\n Are you sure?");
		if (r) {
			setCommand("reset");
		} 
	}

	function setCommand(cmd)
	{
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.open("POST", "/"+cmd,true);
		xmlHttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
		xmlHttp.onreadystatechange = function() {
			if(xmlHttp.readyState == 4 && xmlHttp.status == 200) {
				alert(xmlHttp.responseText);
			}
		};
		xmlHttp.send(cmd); 		
	}
	

	function setAdmin()
	{
		var httpUser = document.getElementById("httpUser");
		var httpPass  = document.getElementById("httpPass");
		var httpPass2 = document.getElementById("httpPass2");
		var obj = new Object();
		
		if(httpPass.value != httpPass2.value)
		{
			httpPass2.setCustomValidity("Passwords Don't Match");
			httpPass2.reportValidity();
		}
		else if(httpUser.reportValidity() && httpPass.reportValidity() && httpPass2.reportValidity())
		{
			obj.httpUser = httpUser.value;
			obj.httpPass  = httpPass.value;
			obj.httpPass2 = httpPass2.value;

			var jsonString= JSON.stringify(obj);
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function()
			{
				if(xmlHttp.readyState == 4 && xmlHttp.status == 200)
				{
					alert(xmlHttp.responseText);
				}
				else
				{
					alert("Command failed!");
				}
			}
			xmlHttp.open("POST", "/setAdmin",true); 
			xmlHttp.send(jsonString); 		
		}
	}
	
	function showAp() {
		var checkBox = document.getElementById("apMode");
		var obj = document.getElementById("apNameForm");
		if (checkBox.checked == true){
			obj.style.display = "block";
		} else {
			obj.style.display = "none";
		}
	}
	
	function selectFile() {
		var btfile = document.getElementById("fileupload");
		btfile.value="";
		btfile.click();
	}
	function fileChange() {
		document.getElementById("progressbar").style = "width: 0%";
		uploadStatus.innerText ="";
		
		document.getElementById("progressAndStatus").style="visibility: hidden";
		document.getElementById("uploadStatus").style="visibility: hidden";
	
		var btfile = document.getElementById("fileupload");
		var txbox = document.getElementById("txtFile");
		var filename = btfile.value.replace(/^.*[\\\/]/, '')
		txbox.value=filename;
		if (filename)
		{
			document.getElementById("btsendFirmware").disabled=false;
		}
	}
	
	
	function progressHandler(event) {
	  document.getElementById("progressAndStatus").style="visibility: visible";
	  document.getElementById("uploadStatus").style="visibility: visible";
	  var percent = (event.loaded / event.total) * 100;
	  document.getElementById("progressbar").style = "width: " + Math.round(percent).toString() + "%";
	  uploadStatus.innerText = Math.round(percent) + "% uploaded... please wait";
	}


	function errorHandler(event) {
	 uploadStatus.innerText = "Upload Failed";
	 document.getElementById("txtFile").value="";
	}

	function abortHandler(event) {
	  uploadStatus.innerText = "Upload Aborted";
	  document.getElementById("txtFile").value="";
	}
	
	function sendFirmware()
	{
		var firmwarefile = document.getElementById("uploadform");
		var req = new XMLHttpRequest();
		var formData = new FormData(firmwarefile);
		
		req.upload.addEventListener("progress", progressHandler, false);
		req.addEventListener("error", errorHandler, false);
		req.addEventListener("abort", abortHandler, false);                            
		req.open("POST", "/upload", true);
		
		req.onreadystatechange = function()
		{
			if(req.readyState == 4 && req.status == 200)
			{
				document.getElementById("progressbar").style = "width: 100%";
				uploadStatus.innerText = "100% uploaded... Success";
				alert("New firmware uploaded with success.");
			}
		}	
		req.send(formData);
	}
	

	
	
	function sendFirmwareButton() {
		var r = confirm("Upload new firmware?");
		if (r) {
			var firmwareSize = document.getElementById("fileupload").files[0].size;
			
			var obj = new Object();
			obj.firmwareSize = firmwareSize
			var jsonString= JSON.stringify(obj);
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.open("POST", "/setFirmwareSize",true); 
			xmlHttp.onreadystatechange = function()
			{
				if(xmlHttp.readyState == 4 && xmlHttp.status == 200)
				{
					sendFirmware();
					document.getElementById("txtFile").value="";
					document.getElementById("btsendFirmware").disabled=true;
				}
			}		
			xmlHttp.send(jsonString); 			
		}
		else
		{
			document.getElementById("txtFile").value="";
			document.getElementById("btsendFirmware").disabled=true;
			document.getElementById("fileupload").value="";
		}
	}
  </script>
  </head>

  <body>

    <div class="container">
            <div class="header">
				<nav>
					<ul class="nav nav-pills pull-right">
                    <li role="presentation"><a href="live">Live</a></li>
                    <li role="presentation" ><a href="network">Network</a></li>
                    <li role="presentation" ><a href="settings">Settings</a></li>
					<li role="presentation" class="active"><a href="admin">Admin</a></li>
					<li role="presentation" ><a href="logout">Logout</a></li>
					</ul>
				</nav>
				<h3 class="text-muted">PumpControl</h3>
			</div>
		<div class="well">
			<form role="form" method="post" action="">

				<!-- Form Name -->
				<legend>Authentication</legend>
				<!-- Text input-->
				<!-- <div class="form-group">
				<input name="checkHttps" id="checkHttps" type="checkbox">Enable Https (Need reboot)
				</div> -->
				<div class="form-group">
				<div class="form-group">
				  <label  for="httpUser">Username</label>  
				  <input id="httpUser" name="httpUser" type="text" class="form-control input-md" data-toggle="tooltip" title="New username" required oninvalid="this.setCustomValidity('Username required')" oninput="this.setCustomValidity('')">
				</div>
				<div class="form-group">
				  <label  for="httpPass">Password</label>  
				  <input id="httpPass" name="httpPass" type="password" class="form-control input-md" data-toggle="tooltip" title="New password" required oninvalid="this.setCustomValidity('Invalid Password!')" oninput="this.setCustomValidity('')">
				</div>
				<div class="form-group">
				  <label  for="httpPass2">Repeat Password</label>  
				  <input id="httpPass2" name="httpPass2" type="password" class="form-control input-md" data-toggle="tooltip" title="Repeat password"  required oninput="this.setCustomValidity('')">
				</div>

				<legend>Firmware</legend>
				<h5 class="text-muted" id="firmversion"></h5>
				<label  for="frmfirm" >New firmware</label> 
				<div class="form-group" id="frmfirm">
					<div class="input-group input-file" >
						<span class="input-group-btn">
							<button class="btn btn-default" type="button" onclick="selectFile()">Choose file</button>
						</span> 
						<input type="text" id="txtFile" readonly class="form-control" placeholder='.bin file' />
						<span class="input-group-btn">
							<button id="btsendFirmware" class="btn btn-default" type="button" disabled onclick="sendFirmwareButton()">Upload</button>
						</span>
					</div>
				</div>
				<div class="progress" style="visibility: hidden" id="progressAndStatus">
					<div class="progress-bar" id="progressbar" role="progressbar" style="width: 0%" ></div>
				</div>
				<h5 class="text-muted" id="uploadStatus" style="visibility: hidden"></h5>
				<div class="form-group">
					<p class="text-right">
						<input id="btReset" name="btReset" class="btn btn-primary" type="button" onclick="confirmReset()" value="Reset" />
						<input id="btReboot" name="btReboot" class="btn btn-primary" type="button" onclick="confirmReboot()" value="Reboot" />
						<input id="btApply" name="singlebutton" class="btn btn-primary" type="button" onclick="setAdmin()" value="Apply" />
					</p>
				</div>
			</form>
			<form id="uploadform" enctype="multipart/form-data" method="post" action="/upload">
			   <input id="fileupload" name="binfile" type="file" onchange="fileChange()" style="display:none">
			   <input type="submit" value="submit" id="submitFirmware" style="display:none"/>
			</form>
		</div>
    </div>
	      <footer class="footer">
        <p>&copy; PumpControl @2019 by <a href="mailto:pedronsg@gmail.com">pedronsg@gmail.com</a></p>
      </footer>
	</div>
  </body>
</html>