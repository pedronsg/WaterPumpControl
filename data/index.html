<!DOCTYPE html><html lang="en">  <head>    <title>PumpControl</title>     <title>Water Pump Control</title>    <link href="/bootstrap.css" rel="stylesheet">    <link href="/jumbotron-narrow.css" rel="stylesheet">	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">	<link rel="manifest" href="/site.webmanifest">	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">	<meta name="msapplication-TileColor" content="#da532c">	<meta name="theme-color" content="#ffffff">	<script src="/Chart.bundle.js"></script>	<script src="/utils.js"></script>	<style>		canvas {		-moz-user-select: none;		-webkit-user-select: none;		-ms-user-select: none;	}    </style>	    <script>var PUMPSTATUS = {  OFF : {value: 0, description: "Off"},   ON: {value: 1, description: "On"},   NOWATER : {value: 2, description: "No water"},  OVERLOAD : {value: 3, description: "Overload"},  FLOODPROTECTION : {value: 4, description: "Flood Protection"}};var INTERVAL=1000;	document.addEventListener('DOMContentLoaded', function() {			getPumpStatus();			setInterval(getPumpStatus, INTERVAL);	}, false);	var maxItems=20;	var amps = [];	var bars = [];	var maxBars = [];	var minBars = [];	var pumpStatusValue = [];	var pumpStatusDescript = [];			function startStop(){			var obj = new Object();		obj.startStop= (document.getElementById("btnStartStop").value == "Start Pump");		var jsonString= JSON.stringify(obj);		var xmlHttp = new XMLHttpRequest();		xmlHttp.open("POST", "/setStatus",true); 		xmlHttp.setRequestHeader("Content-Type", "application/json");		xmlHttp.onreadystatechange = function()		{			if(xmlHttp.readyState == 4 && xmlHttp.status == 200)			{			}		};		xmlHttp.send(jsonString); 			};	function status2string(val)	{		switch(val)		{			case PUMPSTATUS.OFF.value:				return PUMPSTATUS.OFF.description;			break;			case PUMPSTATUS.ON.value:				return PUMPSTATUS.ON.description;			break;				case PUMPSTATUS.NOWATER.value:				return PUMPSTATUS.NOWATER.description;			break;				case PUMPSTATUS.OVERLOAD.value:				return PUMPSTATUS.OVERLOAD.description;			break;					case PUMPSTATUS.FLOODPROTECTION.value:				return PUMPSTATUS.FLOODPROTECTION.description;			break;									default:				return "";			break;		}	}	function getPumpStatus(){			var obj = new Object();				/*if(maxItems==amps.length)		{			obj.numberOfItems=1;		}else{			obj.numberOfItems=maxItems-amps.length;		}*/		obj.numberOfItems=1;		var jsonString= JSON.stringify(obj);		var xmlhttp = new XMLHttpRequest();		xmlhttp.open("POST", "/getPumpStatus",true); 		xmlhttp.setRequestHeader("Content-Type", "application/json");		xmlhttp.onreadystatechange = function() {			if (xmlhttp.readyState == XMLHttpRequest.DONE) {   // XMLHttpRequest.DONE == 4			   if (xmlhttp.status == 200) {					var jsonObj = JSON.parse(xmlhttp.responseText);										pumpStatusLabel.innerText = "Pump Status: " + status2string(jsonObj.pumpStatus);					if(jsonObj.pumpStatus==PUMPSTATUS.OFF.value || jsonObj.pumpStatus==PUMPSTATUS.NOWATER.value || jsonObj.pumpStatus==PUMPSTATUS.FLOODPROTECTION.value)					{						document.getElementById("btnStartStop").value = "Start Pump";					}					else					{						document.getElementById("btnStartStop").value = "Stop Pump";						}										if (amps.length<maxItems)					{						for (i=0;i<maxItems;i++) {							amps.push(jsonObj.values[0].amps);							bars.push(jsonObj.values[0].bars);							maxBars.push(jsonObj.values[0].maxBars);							minBars.push(jsonObj.values[0].minBars);							pumpStatusValue.push(jsonObj.values[0].pumpStatusValue);						}													pumpStatusDescript.push("");												for (j=1;j<pumpStatusValue.length;j++) 						{							if (pumpStatusValue[j] != pumpStatusValue[j-1])							{								pumpStatusDescript.push(status2string(pumpStatusValue[j]).replace(" ","").substring(0, 3));							}							else							{								pumpStatusDescript.push("");							}						}					}else					{						amps.shift();						amps.push(jsonObj.values[0].amps);						bars.shift();						bars.push(jsonObj.values[0].bars);						maxBars.shift();						maxBars.push(jsonObj.values[0].maxBars);						minBars.shift();						minBars.push(jsonObj.values[0].minBars);												pumpStatusValue.shift();						pumpStatusDescript.shift();												if(pumpStatusValue[pumpStatusValue.length-1] != jsonObj.values[0].pumpStatusValue)						{							pumpStatusDescript.push(status2string(jsonObj.values[0].pumpStatusValue).replace(" ","").substring(0, 3));						}						else						{							pumpStatusDescript.push("");						}						pumpStatusValue.push(jsonObj.values[0].pumpStatusValue);											}									var lineChartData = {					labels: pumpStatusDescript,					datasets: [{						label: 'Current (amps)',						borderColor: window.chartColors.green,						backgroundColor: window.chartColors.green,						fill: false,						data: amps,						yAxisID: 'y-axis-1',					}, {						label: 'Pressure (bars)',						borderColor: window.chartColors.blue,						backgroundColor: window.chartColors.blue,						fill: false,						data: bars,						yAxisID: 'y-axis-1'					}, {						label: 'Max (bars)',						borderColor: window.chartColors.red,						backgroundColor: window.chartColors.red,						fill: false,						data: maxBars,						yAxisID: 'y-axis-1',						pointRadius:0					}, {						label: 'Min (bars)',						borderColor: window.chartColors.yellow,						backgroundColor: window.chartColors.yellow,						fill: false,						data: minBars,						yAxisID: 'y-axis-1',						pointRadius:0					}					]					};				   					drawGraph(lineChartData);				}			}		};		xmlhttp.send(jsonString);		//xmlhttp.send();	};			function drawGraph(lineChartData) {			var ctx = document.getElementById('canvas').getContext('2d');			window.myLine = Chart.Line(ctx, {				data: lineChartData,				options: {					responsive: true,					hoverMode: 'index',					stacked: false,					title: {						display: true,						text: 'Live Chart'					},					scales: {						yAxes: [{							type: 'linear',							display: true,							position: 'left',							id: 'y-axis-1',						}]					},					animation: {						duration: 0					}				}			});		}			</script>	      </head>   <body>    <div class="container">      <div class="header">            <nav>                <ul class="nav nav-pills pull-right">                    <li role="presentation" class="active"><a href="live">Live</a>					</li>                    <li role="presentation"><a href="network">Network</a>                    </li>                    <li role="presentation" ><a href="settings">Settings</a>					</li>					<li role="presentation"><a href="admin">Admin</a>                    </li>					</li>					<li role="presentation" ><a href="logout">Logout</a>                    </li>                </ul>            </nav>            <h3 class="text-muted">PumpControl</h3>			<div class="container text-center">				<h4 class="text-muted" id="pumpStatusLabel"></h4>			</div>        </div>       <div style="width:100%;">		<canvas id="canvas"></canvas>	</div>		<legend></legend>		 <input id="btnStartStop" name="singlebutton" class="btn btn-primary btn-block" type="button" onclick="startStop()" value="Stop Pump" />      <footer class="footer">        <p>&copy; PumpControl @2019 by <a href="mailto:pedronsg@gmail.com">pedronsg@gmail.com</a></p>       </footer>     </div>  </body></html>